# nesorter
### _Попытка отсортировать и стримить музыку в удобном виде_

## Структура
```
srv - бекенд часть, существует как отдельный nodejs-проект
ui  - фронтенд часть, существует как отдельный nodejs-проект
```

![Диаграмма классов](https://github.com/nesorter/nesorter/blob/main/readmeAssets/classDiagram.png?raw=true)

## Запуск в Docker
1. Поправить путь маунта с библиотекой треков, файл docker-compose.yml, строка `/Users/kugi/Music:/app/lib`
2. `docker-compose up`
3. После запуска будут доступны веб-сервисы на портах 3000 (ui) и 8000 (icecast)
4. Конфиг icecast находится в `dockerMisc/icecast.xml`, внесенные изменения нужно соответсвенно изменить в `srv/.env` (смена пароля или имя маунта)

## system-wide зависимости [если запуск планируется не в Docker]
Обе части написаны на TypeScript и работают в Node.JS. Перед установкой и запуском убедитесь, что у вас:
- установлен `nodejs`
- установлен `yarn`; его установка: `npm i -g yarn`

Работа вещания построена на `mpv` и `ffmpeg`. Перед использованием функционала проигрывания и вещания убедитесь, что у вас:
- установлены `mpv` и `ffmpeg`
- в случае когда `mpv` и `ffmpeg` недоступны в `$PATH`, следует прописать полный путь до бинарника в конфигурации `.env`

## Установка [если запуск планируется не в Docker]
1. Вызываем соответствующий скрипт 
```sh
./install.sh
```

2. Перед запуском нужно подготовить .env-файл с конфигурацией.
```sh
cp srv/.env.example srv/.env
```

3. После чего нужно отредактировать `srv/.env` прописав нужные параметры. За что отвечает каждый параметр смотреть в конец README.

4. Важно! Инициализация БД. Шаг необязательный, так как в postinstall скрипте оно уже должно было бы полностью заинититься.
```sh
cd srv && yarn db:gen
```

## Запуск [если запуск планируется не в Docker]
Запускать `srv` и `ui` можно через скрипт:
```sh
./run.sh
```

Команды для ручного запуска вот такие:
```
cd srv && yarn service:start
cd ui && yarn start
```

## Описание .env [для запуска в Docker и если запуск планируется не в Docker]
```
API_LISTEN_PORT       - порт бекенда, его изменение не аффектит UI-часть, так что в изменении смысла нет

MPV_PATH              - путь ИЛИ имя бинарника mpv
MPV_FADE_TIME         - время (секунды) fade-in/out между треками [известен баг с нойзом между треками при значении больше 0]

CONTENT_ROOT_DIR_PATH - абсолютный путь до директории с музыкой, при запуске в Docker значение /app/lib
LOG_PATH              - абсолютный путь до файла с логами

SHOUT_HOST            - хост icecast, при запуске в Docker значение icecast2
SHOUT_PORT            - порт icecast, при запуске в Docker значение оставлять как в .env.example
SHOUT_USER            - имя юзера (например source), при запуске в Docker значение оставлять как в .env.example
SHOUT_PASSWORD        - пароль от юзера, при запуске в Docker значение оставлять как в .env.example
SHOUT_MOUNT           - имя маунта, при запуске в Docker значение оставлять как в .env.example
SHOUT_URL             - урл стрима, эта инфа передается в icecast
SHOUT_DESCRIPTION     - описание стрима, эта инфа передается в icecast

FFMPEG_BITRATE        - битрейт потока
FFMPEG_FORMAT         - формат (mp3/ogg) [вроде не работает ogg]
```
